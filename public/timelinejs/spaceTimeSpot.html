<!DOCTYPE html>
<html>
<head>
	
	<title>扰动图斑历史时空播放</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="jquery.min.js"></script>
  <script src="proj4.js"></script>
  <link rel="stylesheet" href="leaflet/dist/leaflet.css"/>
  <script src="leaflet/dist/leaflet.js"></script>
	<link rel="stylesheet" href="dist/css/timeline.css"/>
  <script src="dist/js/timeline.js"></script>
	<style>
		html, body {
			height: 100%;
			width: 100%;
			margin: 0;
		}
	</style>	
</head>
<body>

	<div class="timeline-container timeline-theme-1">
	  <div class="timeline js-timeline" id="timelineDomBody">
	  </div>
	</div>

</body>
<script>

    /*
      *日期转UTC函数
      */
      function dateToUtc(date) {
      var toUTC = new Date((date +" 00:00:00").replace(/\-/g,"\/")).toISOString();
      toUTC=toUTC.split(".")[0]+'Z';
      return toUTC;
    }

    /*
      *获取Iframe参数值函数
      */
    function getIframeUrl(name) {
      var reg = new RegExp("[^\?&]?" + encodeURI(name) + "=[^&]+");
      var arr = window.parent.document.getElementById("hisPlayIframe").contentWindow.location.search.match(reg);//js获取iframe通过url传递的参数,需要iframe的ID
      if (arr != null) {
          return decodeURI(arr[0].substring(arr[0].search("=") + 1));
      }
      return "";
    } 
    /*属性查询图层
    *@method queryWFSServiceByProperty
    *@param propertyValue 属性值
    *@param propertyName 属性名称
    *@param typeName 图层名称
    *@param geoserverQueryUrl geoserverURL查询
    *@return callback
    */
    function queryWFSServiceByProperty(propertyValue,propertyName,typeName,geoserverQueryUrl,callback){
      var filter =
        '<Filter xmlns="http://www.opengis.net/ogc" xmlns:gml="http://www.opengis.net/gml">';
      filter += "<PropertyIsEqualTo>";
      filter += "<PropertyName>" + propertyName + "</PropertyName>";
      filter += "<Literal>" + propertyValue + "</Literal>";
      filter += "</PropertyIsEqualTo>";
      filter += "</Filter>";
      var urlString = geoserverQueryUrl + "/ows";
      var param = {
        service: "WFS",
        version: "1.0.0",
        request: "GetFeature",
        typeName: typeName,
        outputFormat: "application/json",
        filter: filter
      };
      var geojsonUrl = urlString + L.Util.getParamString(param, urlString);
      $.ajax({
        type:"GET",
        url:geojsonUrl,
        dataType:"json", 
        success:function(data){
            console.log("属性查询图层:",data);
            callback(data);
        },
        error:function(jqXHR){
          console.log("发生错误："+ jqXHR.status);
        }
      });
    }

    /*根据地图当前范围获取对应历史影像数据
    *@method getImageInfoByExtent
    *@param getImageInfoByExtentUrl 当前地图范围的历史影像列表接口url
    *@param zoom 地图当前范围级别
    *@param bounds 地图当前范围
    *@param callback 回调函数
    *@return callback
    */
    function getImageInfoByExtent(getImageInfoByExtentUrl,zoom, bounds, callback){
      var urlString = getImageInfoByExtentUrl;
      var xyMin = proj4("EPSG:4326", "EPSG:3857", [
        bounds.getSouthWest().lng,
        bounds.getSouthWest().lat
      ]);
      var xyMax = proj4("EPSG:4326", "EPSG:3857", [
        bounds.getNorthEast().lng,
        bounds.getNorthEast().lat
      ]);
      var param = {
        level: zoom, //地图当前范围级别
        xmin: xyMin[0], //地图当前范围x最小值
        xmax: xyMax[0], //地图当前范围x最大值
        ymin: xyMin[1], //地图当前范围y最小值
        ymax: xyMax[1] //地图当前范围y最大值
      };
      var geojsonUrl = urlString + L.Util.getParamString(param, urlString);
      //${domain}api/Tool/Forward
//       $.ajax({
//         type:"GET",
//         url:geojsonUrl,
//         dataType:"json", 
//         success:function(data){
//             console.log("地图当前范围获取对应历史影像数据:",data);
//             callback(data);
//         },
//         error:function(jqXHR){
//           console.log("发生错误："+ jqXHR.status);
//         }
//       });
        $.ajax({
          type:"POST",
          url:domain+"api/Tool/Forward",
          dataType:"json", 
          headers: {
              Authorization: "Bearer "+ JSON.parse(localStorage.user).accessToken ,
              "Content-Type": "application/json-patch+json"
            },
          body: JSON.stringify({
              method: "GET",
              url: geojsonUrl
          }),
          success:function(data){
              console.log("地图当前范围获取对应历史影像数据:",data);
              callback(data);
          },
          error:function(jqXHR){
            console.log("发生错误："+ jqXHR.status);
          }
        });
    }

    $(function(){
        var l = window.location;  
        var isFormal = l.href.split("/")[3] === "stbcjg";
        var isLocal = l.hostname === "localhost"; 
        var geoserverUrl = isLocal ? "http://183.6.178.124:8143": l.protocol+"//"+l.hostname+":8143";
        geoserverUrl += "/geoserver/ZKYGIS";
        var mapHistorySpotLayerName = isFormal ? "ZKYGIS:bs_spot_history" : "ZKYGIS:bs_spot_history_t";
        //后台接口Url
        domain = isLocal ? "http://183.6.178.124:8001/stbct" : l.origin + "/stbc"+ isFormal ? "" : "t";
        domain += "/";
        console.log("domain",domain);
        var getImageInfoByExtentUrl = "http://www.stbcjg.cn/BasemapService/rest/image/latest/getInfoByExtent";
        baseLayerUrl = 'http://www.stbcjg.cn/BasemapService/rest/image/latest/tile/{z}/{y}/{x}';    
        //获取历史扰动图斑数据列表
        var spotHistoryList = localStorage.getItem("spotHistoryList");
        spotHistoryList = JSON.parse(spotHistoryList);
        console.log(spotHistoryList);
        timeSpotList = [];
        if(spotHistoryList.length>0){
          //动态构造扰动图斑历史时间轴刻度
          for(var i=spotHistoryList.length-1;i >= 0;i--){
            timeSpotList.push(dateToUtc(spotHistoryList[i].archiveTime));
             if(i == spotHistoryList.length-1){
              $('#timelineDomBody').append('<div data-time="'+spotHistoryList[i].archiveTime+'"><div id="map"></div></div>');
             }
             else{
              $('#timelineDomBody').append('<div data-time="'+spotHistoryList[i].archiveTime+'" style="display:none"></div>');
             }
          }
        }

        //var spotHistoryId = getIframeUrl('spotHistoryId');
        //console.log(spotHistoryId);

        $('.js-timeline').Timeline({
          autoplay: false,
          isreplay:true,
          //autoplaySpeed:500,
          pauseOnHover: false
        });

        //动态计算map容器大小
        $("#map").width($(".timeline-list").width());
        $("#map").height($(".timeline-list").height());
    
        var map = L.map('map',
          {
          attributionControl: false,
          center: [33.7243, 106.8751],//中国范围
          zoom: 5
          }
        );
        baseLayer = L.tileLayer(baseLayerUrl, {
          maxZoom: 18
        }).addTo(map);
        
        //timeSpotList = ['2019-08-28Z','2019-08-27Z','2019-08-26Z','2019-08-25Z','2019-08-24Z','2019-08-23Z','2019-08-22Z','2019-08-21Z','2019-08-20Z','2019-08-19Z'];
        //地图叠加历史扰动图斑      
        spotWmsLayer = L.tileLayer.wms(geoserverUrl+"/wms?", {         
          layers:mapHistorySpotLayerName,//需要加载的图层
          format: "image/png", //返回的数据格式
          transparent: true,
          cql_filter: "archive_time = " +timeSpotList[0]
        }).addTo(map);
        //定位到图斑范围
        queryWFSServiceByProperty(spotHistoryList[0].id,"id",mapHistorySpotLayerName,geoserverUrl,function(data){
           if(data.features && data.features.length>0){
             var feature = data.features[0];
             var coordinate = feature.geometry.coordinates[0][0][0];
             var latlng = [coordinate[1],coordinate[0]];
             map.setView(latlng,15);
             //根据地图当前范围获取对应历史影像数据
             setTimeout(() => {
              var zoom = map.getZoom();
              var bounds = map.getBounds();
              getImageInfoByExtent(getImageInfoByExtentUrl,zoom,bounds,function(data){

              })               
             }, 800);

           }
        });
    }); 
    
    </script>
</html>
